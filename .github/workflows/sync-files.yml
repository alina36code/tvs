# 环境：PAT_PUSH 已从 secrets 传入
set -e

# 1) 简单验证 PAT 存在
if [ -z "${PAT_PUSH}" ]; then
  echo "ERROR: PAT_PUSH secret is empty. 请在仓库 Secrets 添加 PAT_PUSH。"
  exit 1
fi

# 2) 验证 PAT 可用并显示所属用户名（不打印 token）
echo "验证 PAT..."
user_json=$(curl -s -H "Authorization: token ${PAT_PUSH}" https://api.github.com/user || true)
login=$(echo "$user_json" | jq -r .login || true)
if [ -z "$login" ] || [ "$login" = "null" ]; then
  echo "ERROR: PAT 无效或权限不足。API 返回:"
  echo "$user_json"
  exit 1
fi
echo "PAT 所属用户: $login"

# 3) 准备并提交（你的提交逻辑）
echo "${{ steps.upstream.outputs.upstream_sha }}" > "${{ env.LAST_SYNC_FILE }}"
git add "${{ env.LAST_SYNC_FILE }}" || true
if [ -n "$(git status --porcelain)" ]; then
  git add .
  git commit -m "自动更新 (同步自 ${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}@${{ steps.upstream.outputs.upstream_sha }}) [auto-sync]"
else
  git commit --allow-empty -m "更新 last_synced_upstream_commit -> ${{ steps.upstream.outputs.upstream_sha }} [auto-sync]"
fi

# 4) 使用 PAT 推送（直接用一条带 token 的 push，或设置 remote）
remote_url="https://x-access-token:${PAT_PUSH}@github.com/${{ github.repository }}.git"

# 可选：显示 remote（mask token）
git remote -v
echo "使用替代 remote 推送（token 未在日志中显示）..."

# 直接推送到目标分支
git push "${remote_url}" HEAD:main
