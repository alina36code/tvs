name: 同步文件（轮询 + 记录上次 upstream commit）

on:
  schedule:
    # 每天北京时间上午9点执行 (UTC+8)
    - cron: '0 1 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_OWNER: PizazzGY
      UPSTREAM_REPO: NewTVBox
      UPSTREAM_BRANCH: main
      # 若上游 ZIP 地址会变化，请在此修改
      ZIP_URL: https://raw.githubusercontent.com/PizazzGY/NewTVBox/refs/heads/main/%E5%8D%95%E7%BA%BF%E8%B7%AF.zip
      LAST_SYNC_FILE: .github/last_synced_upstream_commit
    permissions:
      contents: write

    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        persist-credentials: true

    - name: 设置 Git 配置
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: 确保 jq 可用
      run: |
        if ! command -v jq >/dev/null 2>&1; then
          sudo apt-get update -y
          sudo apt-get install -y jq
        fi

    - name: 获取上游最新 commit SHA
      id: upstream
      run: |
        API="https://api.github.com/repos/${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}/commits/${{ env.UPSTREAM_BRANCH }}"
        echo "Querying $API"
        upstream_sha=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API" | jq -r .sha)
        if [ -z "$upstream_sha" ] || [ "$upstream_sha" = "null" ]; then
          echo "无法获取上游 SHA"
          exit 1
        fi
        echo "upstream_sha=$upstream_sha" >> $GITHUB_OUTPUT

    - name: 检查上次同步的 SHA
      id: check
      run: |
        LAST_FILE="${{ env.LAST_SYNC_FILE }}"
        if [ -f "$LAST_FILE" ]; then
          last_sha=$(cat "$LAST_FILE" || true)
        else
          last_sha=""
        fi
        echo "last_sha=$last_sha" >> $GITHUB_OUTPUT
        if [ "$last_sha" = "${{ steps.upstream.outputs.upstream_sha }}" ]; then
          echo "has-changes=false" >> $GITHUB_OUTPUT
        else
          echo "has-changes=true" >> $GITHUB_OUTPUT
        fi

    - name: 上游未变更，退出
      if: steps.check.outputs.has-changes == 'false'
      run: |
        echo "上游 commit 未变化，跳过同步。"

    - name: 下载并解压文件（仅在上游变更时）
      if: steps.check.outputs.has-changes == 'true'
      run: |
        echo "开始下载文件..."
        curl -L -o "data.zip" "${{ env.ZIP_URL }}"
        if [ ! -f "data.zip" ]; then
          echo "下载失败"
          exit 1
        fi
        echo "解压到临时目录 tmp ..."
        mkdir -p tmp
        unzip -o "data.zip" -d tmp
        echo "查找 tvbox 目录..."
        if [ -d "tmp/TVBoxOSC/tvbox" ]; then
          echo "找到 tmp/TVBoxOSC/tvbox，复制到仓库根目录..."
          rsync -a tmp/TVBoxOSC/tvbox/ .
        else
          tvbox_dir=$(find tmp -type d -name tvbox | head -n1 || true)
          if [ -n "$tvbox_dir" ]; then
            echo "找到 tvbox 目录：$tvbox_dir，复制到仓库根目录..."
            rsync -a "$tvbox_dir"/. .
          else
            echo "未找到 tvbox 目录，列出 tmp 内容以供调试:"
            ls -R tmp
            rm -rf tmp data.zip
            exit 1
          fi
        fi
        echo "清理临时文件..."
        rm -rf tmp data.zip
        echo "下载并复制完成"

    - name: 更新 last_synced 文件并提交更改（仅在上游变更时）
      if: steps.check.outputs.has-changes == 'true'
      run: |
        echo "${{ steps.upstream.outputs.upstream_sha }}" > "${{ env.LAST_SYNC_FILE }}"
        git add "${{ env.LAST_SYNC_FILE }}" || true
        # 如果有真实文件更改则一并提交；若没有文件差异，也提交一个空提交以记录已处理的 upstream SHA
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "自动更新 (同步自 ${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}@${{ steps.upstream.outputs.upstream_sha }})"
          git push origin HEAD:main
          echo "已提交并推送更改。"
        else
          git commit --allow-empty -m "更新 last_synced_upstream_commit -> ${{ steps.upstream.outputs.upstream_sha }}"
          git push origin HEAD:main
          echo "无内容变化，但已更新 last_synced 文件并推送。"
        fi
